#!/bin/bash
source ~/.cache/wal/colors.sh
dmenucmd="dmenu -sb $color0 -sf $color6 -nf $color0 -nb $color6 -l 20 -z 200 -i"
wallpapercolor=$color0

mainmenu() {
CHOICES=$(echo -e "log/shut\ndmenu\nsteam\npacman\nnetwork\ndisplay\naudio\ntheme\nusb\nbluetooth\nkeys\nesc=out" | $dmenucmd )

case "$CHOICES" in
	dmenu) dmenufunc ;;
	steam) steammenu ;;
	log/shut) shutdownfunc ;;
	pacman) pacmansettings ;;
	network) st -e sudo nmtui ;;
	display) displaysettings ;;
	audio) st -e pulsemixer ;;
	theme) theme ;;
	bluetooth) blueman ;;
	usb) st -e bashtop ;;
	keys) keys ;;
esac
}

dmenufunc() {
	dmenu_path | $dmenucmd "$@" | ${SHELL:-"/bin/sh"} &
}

keys() {
[[ -f ~/.Xmodmap ]] && xmodmap ~/.Xmodmap &
xset r rate 300 50 &
xcape -e 'Super_L=Escape' &
xcape -e 'Super_R=Escape'
}

shutdownfunc() {
powerchoice=$(echo -e "logoff\nshutdown\nrestart\nesc=.." | $dmenucmd )

case "$powerchoice" in
	#logoff)        kill -9 -1                         ;;
	logoff)       dwmc quit                          ;;
	shutdown)     shutdown now                       ;;
	restart)     shutdown now                       ;;
	*) mainmenu ;;
esac
}

pacmansettings() {
PCHOICES=$(echo -e "install\nuninstall\nupdate\naur\nesc=.." | $dmenucmd )
case "$PCHOICES" in
	install) st -e fzpacins         ;;
	uninstall) st -e fzpacun        ;;
	update) st -e sudo pacman -Syyu ;;
	aur) st -e fzyay ;;
	*) mainmenu ;;
esac
}

displaysettings() {
screenopts=$(echo -e "displayopts\nscreenpwr\nesc=.." | $dmenucmd )
case "$screenopts" in
	displayopts) xset -dpms s off | arandr ;;
	screenpwr) powersettings ;;
	*) mainmenu ;;
esac
}

powersettings() {
PCHOICES=$(echo -e "screensleepon\nscreensleepoff\nesc=.." | $dmenucmd )
case "$PCHOICES" in
	screensleepon) xset -dpms s on         ;;
	screensleepoff) xset -dpms s off       ;;
	*) displaysettings ;;
esac
}

#this had to be out of a func for both the theme
#and wallpapers to get it
#random number generator for wallpaper
RANDNUM=$( echo $(($RANDOM % 6 + 1)) )
case "$RANDNUM" in
	1)  col="$color1"  ;;	
	2)  col="$color2"  ;;	
	3)  col="$color3"  ;;	
	4)  col="$color4"  ;;	
	5)  col="$color5"  ;;	
	6)  col="$color6"  ;;	
esac

setwallpaper() {
	wallchoice=$( sxiv ~/Pictures/ -o )
	feh --bg-fill $wallchoice
}

theme() {
powerchoice=$(echo -e "colorschemes\nwallpaper" | $dmenucmd )

case "$powerchoice" in
	#logoff)        kill -9 -1                         ;;
	colorschemes)     bashwal -t                       ;;
	wallpaper)     setwallpaper                       ;;
esac

}

wallpaper() {
xsetroot -solid "$color0"
}

steammenu() {
choice=$(find ~/.steam/steam/steamapps -maxdepth 1 -type f -name '*.acf' -exec awk -F '"' '/"name/{ printf $4 "|" } END { print "" }' {} \; | column -t -s '|' | sort -k 2 | grep -v 'Steam\|Proton' | $dmenucmd )

choicep=$(find ~/.steam/steam/steamapps -maxdepth 1 -type f -name '*.acf' -exec awk -F '"' '/"appid|name/{ printf $4 "|" } END { print "" }' {} \; | column -t -s '|' | sort -k 2 | grep "$choice" | tr -d "$choice" )

if [[ -z $choice ]]; then exit
else steam steam://run/$choicep
fi
}

case "$1" in
	dmenu) dmenufunc ;;
	log/shut) shutdownfunc ;;
	pacman) pacmansettings ;;
	network) st -e sudo nmtui ;;
	display) displaysettings ;;
	audio) st -e pulsemixer ;;
	theme) theme ;;
	bluetooth) blueberry ;;
	usb) st -e bashtop ;;
	keys) keys ;;
	steam) steammenu ;;
	wallpaper) wallpaper ;;
	*) mainmenu ;;
esac
